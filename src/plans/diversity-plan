You are working in the repo `fpl-radar`.

Implement **Engine v1.1 – Step 4: Diversity limiting (avoid repeating the same players in predictions)**.

## Context
Right now, the per-entry transfer predictions (Issue #15) can show the same IN player or OUT player repeatedly across the top N results. This looks spammy and reduces usefulness.

We want to keep high-quality predictions but ensure **variety**:
- limit how often the same `inPlayerId` appears in the returned list
- optionally also limit repeats of `outPlayerId`
- keep this deterministic and explainable

This is a *presentation/reranking* step at the end of prediction — we should not change legality or base scoring.

---

## Scope
- Modify the per-entry prediction output selection in:
  - `predictTransfersForEntry(...)` (Issue #15 implementation)
- Do NOT change:
  - candidate generation legality
  - sell/buy scoring
  - probability calculation logic beyond recomputing normalisation after filtering
- Add tunable constants for caps

---

## Deliverables

### A) Config constants
Add to:
- `src/prediction/transferPrediction/constants.ts`

```ts
export const DIVERSITY = {
  MAX_PER_IN_PLAYER: 3,   // max times same IN can appear
  MAX_PER_OUT_PLAYER: 3,  // max times same OUT can appear
  MAX_RESULTS: 20,        // existing default is fine; keep here if you want
} as const;
```

If you already have MAX_RESULTS elsewhere, keep it consistent.

B) Diversity selection helper

Create:

- src/prediction/transferPrediction/diversify.ts

Export:
```ts

import type { TransferPrediction } from "./types";
export function diversifyPredictions(params: {
  predictions: TransferPrediction[]; // already sorted by score desc
  maxResults: number;
  maxPerInPlayer: number;
  maxPerOutPlayer: number;
}): { selected: TransferPrediction[]; dropped: number }
```

Algorithm (greedy, deterministic):

1. Iterate predictions in descending score order

2. Maintain counters:

- inCount: Map<number, number>

- outCount: Map<number, number>

3. Select prediction if:

- inCount[inPlayerId] < maxPerInPlayer

- AND outCount[outPlayerId] < maxPerOutPlayer

4. Stop when selected.length === maxResults

5. Return selected + dropped count

Edge behaviour:

- If selection produces too few results (< maxResults / 2), relax constraints in a second pass:

- - increase caps by +1 (or disable out cap) and refill from remaining items. This ensures we don’t accidentally return 3 results when the pool is small.

Document this behaviour in code comments.


C) Integrate into prediction pipeline

Update:

- src/prediction/transferPrediction/predict.ts

Where you currently:

- compute all candidate scores

- sort desc

- take top maxResults

- softmax normalise probabilities

Change order to:

- sort desc

- run diversifyPredictions(...) to pick up to maxResults

- recompute probabilities only on the selected subset

- return selected

Also:

- include a small metadata field (optional) indicating diversity was applied:

- - meta.droppedForDiversity count. If you already have meta, add it there; otherwise skip.


D) Update script output (manual verification)

Update:

- src/scripts/predict-transfers.ts

Print:

- total predictions before diversity

- dropped count

- final returned count

Also show that top N now includes more unique INs/OUTs.

E) Tests

Create:

- src/prediction/transferPrediction/diversify.test.ts

Test cases:

1. Many predictions with same IN player:

- ensure selected includes at most MAX_PER_IN_PLAYER occurrences

2. Same for OUT player

3. Determinism:

- same input list → same output list

4. Relaxation behaviour:

- if constraints too tight, second pass increases count

These tests should be pure (no DB).

Acceptance Criteria

1. Returned predictions contain more variety:

- IN players not repeated excessively

- OUT players not repeated excessively

2. Still prioritises highest scores (greedy pass)

3. Probabilities are re-normalised after filtering

4. Deterministic and easy to tune via constants

5. Unit tests cover caps and determinism

Implementation Order

1. Add constants

2. Implement diversify helper

3. Integrate into prediction pipeline and re-normalise probabilities

4. Update script output

5. Add unit tests

Keep this as a final selection/reranking step only.